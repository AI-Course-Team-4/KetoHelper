warning: in the working copy of 'backend/app/core/orchestrator.py', LF will be replaced by CRLF the next time Git touches it
[1mdiff --git a/backend/app/core/orchestrator.py b/backend/app/core/orchestrator.py[m
[1mindex e05bc2fe..219b11ef 100644[m
[1m--- a/backend/app/core/orchestrator.py[m
[1m+++ b/backend/app/core/orchestrator.py[m
[36m@@ -21,6 +21,8 @@[m [mfrom app.tools.meal.keto_score import KetoScoreCalculator[m
 from app.tools.shared.temporary_dislikes_extractor import temp_dislikes_extractor[m
 from app.agents.meal_planner import MealPlannerAgent[m
 from app.agents.chat_agent import SimpleKetoCoachAgent[m
[32m+[m[32mfrom app.shared.utils.calendar_utils import CalendarUtils[m
[32m+[m[32mfrom app.tools.calendar.calendar_saver import CalendarSaver[m
 [m
 # í”„ë¡¬í”„íŠ¸ ëª¨ë“ˆ import (ì¤‘ì•™ì§‘ì¤‘í™”ëœ êµ¬ì¡°)[m
 from app.prompts.chat.intent_classification import INTENT_CLASSIFICATION_PROMPT, get_intent_prompt[m
[36m@@ -29,6 +31,11 @@[m [mfrom app.prompts.chat.response_generation import RESPONSE_GENERATION_PROMPT, RES[m
 from app.prompts.meal.recipe_response import RECIPE_RESPONSE_GENERATION_PROMPT[m
 from app.prompts.restaurant.search_improvement import PLACE_SEARCH_IMPROVEMENT_PROMPT[m
 from app.prompts.restaurant.search_failure import PLACE_SEARCH_FAILURE_PROMPT[m
[32m+[m[32mfrom app.prompts.calendar import ([m
[32m+[m[32m    CALENDAR_SAVE_CONFIRMATION_PROMPT,[m
[32m+[m[32m    CALENDAR_SAVE_FAILURE_PROMPT,[m
[32m+[m[32m    CALENDAR_MEAL_PLAN_VALIDATION_PROMPT[m
[32m+[m[32m)[m
 [m
 from typing_extensions import TypedDict, NotRequired[m
 [m
[36m@@ -77,9 +84,11 @@[m [mclass KetoCoachAgent:[m
         self.hybrid_search = hybrid_search_tool  # ì´ë¯¸ ì´ˆê¸°í™”ëœ ì¸ìŠ¤í„´ìŠ¤ ì‚¬ìš©[m
         self.place_search = PlaceSearchTool()[m
         self.restaurant_hybrid_search = restaurant_hybrid_search_tool  # ì‹ë‹¹ RAG ê²€ìƒ‰[m
[31m-        self.keto_score = KetoScoreCalculator() [m
[32m+[m[32m        self.keto_score = KetoScoreCalculator()[m
         self.meal_planner = MealPlannerAgent()[m
         self.simple_agent = SimpleKetoCoachAgent()[m
[32m+[m[32m        self.calendar_saver = CalendarSaver()[m
[32m+[m[32m        self.calendar_utils = CalendarUtils()[m
         [m
         # ì›Œí¬í”Œë¡œìš° ê·¸ë˜í”„ êµ¬ì„±[m
         self.workflow = self._build_workflow()[m
[36m@@ -214,7 +223,7 @@[m [mclass KetoCoachAgent:[m
                     state["calendar_save_request"] = True[m
                     [m
                     # ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ìµœê·¼ ì‹ë‹¨ ë°ì´í„° ì°¾ê¸°[m
[31m-                    meal_plan_data = self._find_recent_meal_plan(chat_history)[m
[32m+[m[32m                    meal_plan_data = self.calendar_utils.find_recent_meal_plan(chat_history)[m
                     if meal_plan_data:[m
                         state["meal_plan_data"] = meal_plan_data[m
                         # save_to_calendar_data ìƒì„±ì€ ë³„ë„ ë…¸ë“œì—ì„œ ì²˜ë¦¬[m
[36m@@ -307,58 +316,7 @@[m [mclass KetoCoachAgent:[m
         [m
         return initial_intent[m
     [m
[31m-    def _find_recent_meal_plan(self, chat_history: List[str]) -> Optional[Dict]:[m
[31m-        """ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ìµœê·¼ ì‹ë‹¨ ë°ì´í„° ì°¾ê¸°"""[m
[31m-        [m
[31m-        # ì—­ìˆœìœ¼ë¡œ íƒìƒ‰ (ìµœê·¼ ëŒ€í™”ë¶€í„°)[m
[31m-        for msg in reversed(chat_history[-10:]):  # ìµœê·¼ 10ê°œ ë©”ì‹œì§€ë§Œ í™•ì¸[m
[31m-            # ì‹ë‹¨í‘œ íŒ¨í„´ ì°¾ê¸°[m
[31m-            if "ì¼ì°¨:" in msg or "ì•„ì¹¨:" in msg or "ì ì‹¬:" in msg or "ì €ë…:" in msg:[m
[31m-                # ê°„ë‹¨í•œ íŒŒì‹± (ì‹¤ì œë¡œëŠ” ë” ì •êµí•˜ê²Œ êµ¬í˜„ í•„ìš”)[m
[31m-                days = [][m
[31m-                lines = msg.split('\n')[m
[31m-                [m
[31m-                current_day = {}[m
[31m-                for line in lines:[m
[31m-                    if 'ì•„ì¹¨:' in line:[m
[31m-                        current_day['breakfast'] = {'title': line.split('ì•„ì¹¨:')[1].strip()}[m
[31m-                    elif 'ì ì‹¬:' in line:[m
[31m-                        current_day['lunch'] = {'title': line.split('ì ì‹¬:')[1].strip()}[m
[31m-                    elif 'ì €ë…:' in line:[m
[31m-                        current_day['dinner'] = {'title': line.split('ì €ë…:')[1].strip()}[m
[31m-                    elif 'ê°„ì‹:' in line:[m
[31m-                        current_day['snack'] = {'title': line.split('ê°„ì‹:')[1].strip()}[m
[31m-                    [m
[31m-                    # í•˜ë£¨ ë‹¨ìœ„ë¡œ ì €ì¥[m
[31m-                    if 'ì¼ì°¨:' in line and current_day:[m
[31m-                        days.append(current_day)[m
[31m-                        current_day = {}[m
[31m-                [m
[31m-                # ë§ˆì§€ë§‰ ë‚  ì¶”ê°€[m
[31m-                if current_day:[m
[31m-                    days.append(current_day)[m
[31m-                [m
[31m-                if days:[m
[31m-                    # duration_daysë¥¼ ë” ì •í™•í•˜ê²Œ ì„¤ì •[m
[31m-                    found_duration = len(days)[m
[31m-                    [m
[31m-                    # ë©”ì‹œì§€ì—ì„œ ìˆ«ì(ì¼ì°¨) ì°¾ê¸°ë¡œ ì¼ìˆ˜ ì¶”ì¶œ[m
[31m-                    try:[m
[31m-                        from app.tools.shared.date_parser import DateParser[m
[31m-                        date_parser = DateParser()[m
[31m-                        extracted_days = date_parser._extract_duration_days(msg)[m
[31m-                        if extracted_days and extracted_days > 0:[m
[31m-                            found_duration = extracted_days[m
[31m-                            print(f"ğŸ” ë©”ì‹œì§€ì—ì„œ ì¶”ì¶œí•œ ì¼ìˆ˜: {found_duration}")[m
[31m-                    except Exception as e:[m
[31m-                        print(f"âš ï¸ ì¼ìˆ˜ ì¶”ì¶œ ì¤‘ ì˜¤ë¥˜: {e}")[m
[31m-                    [m
[31m-                    return {[m
[31m-                        'days': days,[m
[31m-                        'duration_days': found_duration[m
[31m-                    }[m
[31m-        [m
[31m-        return None[m
[32m+[m[32m    # _find_recent_meal_plan í•¨ìˆ˜ ì œê±° - CalendarUtilsë¡œ ì´ë™[m
 [m
     def _route_condition(self, state: AgentState) -> str:[m
         """ë¼ìš°íŒ… ì¡°ê±´ í•¨ìˆ˜"""[m
[36m@@ -824,241 +782,87 @@[m [mclass KetoCoachAgent:[m
         return state[m
     [m
     async def _calendar_save_node(self, state: AgentState) -> AgentState:[m
[31m-        """ìº˜ë¦°ë” ì €ì¥ ì²˜ë¦¬ ë…¸ë“œ"""[m
[32m+[m[32m        """ìº˜ë¦°ë” ì €ì¥ ì²˜ë¦¬ ë…¸ë“œ (CalendarSaver ì‚¬ìš©, ì¶©ëŒ í•´ê²° í¬í•¨)"""[m
         [m
         try:[m
             message = state["messages"][-1].content if state["messages"] else ""[m
[31m-            [m
[31m-            # ë‚ ì§œ íŒŒì‹±[m
[31m-            from app.tools.shared.date_parser import DateParser[m
[31m-            date_parser = DateParser()[m
[31m-            [m
[31m-            # ëŒ€í™” íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸° (ë©”ëª¨ë¦¬ íˆìŠ¤í† ë¦¬ + ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ)[m
[32m+[m
[32m+[m[32m            # 1. ì¶©ëŒ í•´ê²° ìƒíƒœì¸ì§€ ë¨¼ì € í™•ì¸[m
[32m+[m[32m            if state.get("calendar_conflict_info") and state.get("pending_meal_logs"):[m
[32m+[m[32m                print(f"ğŸ”„ ìº˜ë¦°ë” ì¶©ëŒ í•´ê²° ì²˜ë¦¬ ì¤‘: '{message}'")[m
[32m+[m
[32m+[m[32m                # ì¶©ëŒ í•´ê²° ì²˜ë¦¬[m
[32m+[m[32m                conflict_result = await self.calendar_saver.handle_conflict_resolution([m
[32m+[m[32m                    state, message,[m
[32m+[m[32m                    state["calendar_conflict_info"],[m
[32m+[m[32m                    state["pending_meal_logs"],[m
[32m+[m[32m                    state.get("save_to_calendar_data", {})[m
[32m+[m[32m                )[m
[32m+[m
[32m+[m[32m                # ì¶©ëŒ ì²˜ë¦¬ ì™„ë£Œ í›„ ìƒíƒœ ì •ë¦¬[m
[32m+[m[32m                if "calendar_conflict_info" in state:[m
[32m+[m[32m                    del state["calendar_conflict_info"][m
[32m+[m[32m                if "pending_meal_logs" in state:[m
[32m+[m[32m                    del state["pending_meal_logs"][m
[32m+[m
[32m+[m[32m                state["response"] = conflict_result["message"][m
[32m+[m
[32m+[m[32m                state["tool_calls"].append({[m
[32m+[m[32m                    "tool": "calendar_conflict_resolver",[m
[32m+[m[32m                    "success": conflict_result["success"],[m
[32m+[m[32m                    "action_taken": conflict_result.get("action_taken", "unknown"),[m
[32m+[m[32m                    "method": "handle_conflict_resolution"[m
[32m+[m[32m                })[m
[32m+[m
[32m+[m[32m                return state[m
[32m+[m
[32m+[m[32m            # 2. ì¼ë°˜ ìº˜ë¦°ë” ì €ì¥ ì²˜ë¦¬[m
[32m+[m[32m            # ëŒ€í™” íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°[m
             chat_history = [][m
[31m-            [m
             if state["messages"]:[m
                 chat_history = [msg.content for msg in state["messages"]][m
[31m-            else:[m
[31m-                state["response"] = "ëŒ€í™” íˆìŠ¤í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì‹ë‹¨ì„ ìƒì„±í•´ì£¼ì„¸ìš”."[m
[31m-                return state[m
[31m-                [m
[31m-            parsed_date = date_parser.extract_date_from_message_with_context(message, chat_history)[m
[31m-            [m
[31m-            if not parsed_date:[m
[31m-                state["response"] = "ë‚ ì§œë¥¼ íŒŒì•…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë” êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”. (ì˜ˆ: 'ë‹¤ìŒì£¼ ì›”ìš”ì¼ë¶€í„°', 'ë‚´ì¼ë¶€í„°')"[m
[31m-                return state[m
[31m-            [m
[31m-            # meal_plan_dataë¥¼ ì°¾ê¸° - stateì—ì„œ ë¨¼ì € í™•ì¸[m
[31m-            meal_plan_data = state.get("meal_plan_data")[m
[31m-            [m
[31m-            if not meal_plan_data:[m
[31m-                print(f"ğŸ” ì‹ë‹¨ ì¶”ì¶œ ì¤‘: ê¸°ì¡´ ì±„íŒ… íˆìŠ¤í† ë¦¬ {len(chat_history)}ê°œ ë©”ì‹œì§€ ë¶„ì„")[m
[31m-                meal_plan_data = self._find_recent_meal_plan(chat_history)[m
[31m-                [m
[31m-                # ë©”ëª¨ë¦¬ íˆìŠ¤í† ë¦¬ì—ì„œ ì°¾ì§€ ëª»í•œ ê²½ìš° ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì§ì ‘ ì¡°íšŒ[m
[31m-                if not meal_plan_data and state.get("thread_id"):[m
[31m-                    try:[m
[31m-                        from app.core.database import supabase[m
[31m-                        print(f"ğŸ” ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì‹œë„: thread_id={state['thread_id']}")[m
[31m-                        db_history = supabase.table("chat").select("message").eq("thread_id", state["thread_id"]).order("created_at", desc=True).limit(20).execute()[m
[31m-                        [m
[31m-                        db_messages = [msg["message"] for msg in db_history.data if msg.get("message")][m
[31m-                        print(f"ğŸ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ {len(db_messages)}ê°œ ë©”ì‹œì§€ ì¡°íšŒ")[m
[31m-                        [m
[31m-                        if db_messages:[m
[31m-                            meal_plan_data = self._find_recent_meal_plan(db_messages)[m
[31m-                            if meal_plan_data:[m
[31m-                                print(f"ğŸ” ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‹ë‹¨ ë°œê²¬: {meal_plan_data}")[m
[31m-                    except Exception as db_error:[m
[31m-                        print(f"âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨: {db_error}")[m
[31m-                [m
[31m-            if not meal_plan_data:[m
[31m-                state["response"] = "ì €ì¥í•  ì‹ë‹¨ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì‹ë‹¨ì„ ìƒì„±í•´ì£¼ì„¸ìš”."[m
[31m-                return state[m
[31m-            [m
[31m-            # duration_days ì¶”ì¶œ (ë” ì •í™•í•œ ë°©ë²• ì‚¬ìš©)[m
[31m-            duration_days = None[m
[31m-            [m
[31m-            # 1. meal_plan_dataì—ì„œ duration_days ë¨¼ì € í™•ì¸[m
[31m-            if 'duration_days' in meal_plan_data:[m
[31m-                duration_days = meal_plan_data['duration_days'][m
[31m-                print(f"ğŸ” DEBUG: meal_plan_dataì—ì„œ duration_days ì¶”ì¶œ: {duration_days}")[m
[31m-            [m
[31m-            # 2. days ë°°ì—´ ê¸¸ì´ë¡œ í™•ì¸[m
[31m-            if duration_days is None and 'days' in meal_plan_data:[m
[31m-                duration_days = len(meal_plan_data['days'])[m
[31m-                print(f"ğŸ” DEBUG: days ë°°ì—´ ê¸¸ì´ë¡œ duration_days ì¶”ì¶œ: {duration_days}")[m
[31m-            [m
[31m-            # 3. ëŒ€í™” íˆìŠ¤í† ë¦¬ì—ì„œ ë” ì •í™•í•œ ì¼ìˆ˜ ì°¾ê¸°[m
[31m-            if duration_days is None or duration_days == 1:[m
[31m-                # DateParserì˜ _extract_duration_daysë¡œ ë‹¤ì‹œ ì‹œë„[m
[31m-                for history_msg in reversed(chat_history[-5:]):[m
[31m-                    extracted_days = date_parser._extract_duration_days(history_msg)[m
[31m-                    if extracted_days and extracted_days > 1:[m
[31m-                        duration_days = extracted_days[m
[31m-                        print(f"ğŸ” DEBUG: ì±„íŒ… íˆìŠ¤í† ë¦¬ì—ì„œ ì¼ìˆ˜ ì¬ì¶”ì¶œ: {duration_days}")[m
[31m-                        break[m
[31m-            [m
[31m-            # ìµœì¢… ê¸°ë³¸ê°’ (1ì¼ì´ ì•„ë‹ˆë©´)[m
[31m-            if duration_days is None:[m
[31m-                duration_days = 3  # ê¸°ë³¸ 3ì¼[m
[31m-                print(f"ğŸ” DEBUG: ê¸°ë³¸ê°’ ì‚¬ìš©: {duration_days}ì¼")[m
[31m-            [m
[31m-            print(f"ğŸ” DEBUG: ìº˜ë¦°ë” ì €ì¥ - meal_plan_data: {meal_plan_data}")[m
[31m-            print(f"ğŸ” DEBUG: ìº˜ë¦°ë” ì €ì¥ - ìµœì¢… duration_days: {duration_days}")[m
[31m-            print(f"ğŸ” DEBUG: ìº˜ë¦°ë” ì €ì¥ - parsed_date.date: {parsed_date.date}")[m
[31m-            print(f"ğŸ” DEBUG: ìº˜ë¦°ë” ì €ì¥ - parsed_date.description: {parsed_date.description}")[m
[31m-            [m
[31m-            # ì¼ë³„ ì‹ë‹¨ ë°ì´í„°ë¥¼ ì§ì ‘ í¬í•¨í•œ save_data ìƒì„±[m
[31m-            days_data = [][m
[31m-            [m
[31m-            if meal_plan_data and 'days' in meal_plan_data:[m
[31m-                days_data = meal_plan_data['days'][m
[31m-            else:[m
[31m-                # ê¸°ë³¸ ì‹ë‹¨ìœ¼ë¡œ fallback[m
[31m-                for i in range(duration_days):[m
[31m-                    days_data.append({[m
[31m-                        'breakfast': {'title': f'í‚¤í†  ì•„ì¹¨ ë©”ë‰´ {i+1}ì¼ì°¨'},[m
[31m-                        'lunch': {'title': f'í‚¤í†  ì ì‹¬ ë©”ë‰´ {i+1}ì¼ì°¨'},[m
[31m-                        'dinner': {'title': f'í‚¤í†  ì €ë… ë©”ë‰´ {i+1}ì¼ì°¨'},[m
[31m-                        'snack': {'title': f'í‚¤í†  ê°„ì‹ {i+1}ì¼ì°¨'}[m
[31m-                    })[m
[31m-            [m
[31m-            save_data = {[m
[31m-                "action": "save_to_calendar",[m
[31m-                "start_date": parsed_date.date.isoformat(),[m
[31m-                "duration_days": duration_days,[m
[31m-                "meal_plan_data": meal_plan_data,[m
[31m-                "days_data": days_data,  # ì§ì ‘ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì¼ë³„ ë°ì´í„° ì¶”ê°€[m
[31m-                "message": f"{duration_days}ì¼ì¹˜ ì‹ë‹¨í‘œë¥¼ {parsed_date.date.strftime('%Yë…„ %mì›” %dì¼')}ë¶€í„° ìº˜ë¦°ë”ì— ì €ì¥í•©ë‹ˆë‹¤."[m
[31m-            }[m
[31m-            [m
[31m-            print(f"ğŸ” DEBUG: save_data êµ¬ì¡°: {save_data}")[m
[31m-            print(f"ğŸ” DEBUG: days_data ê¸¸ì´: {len(days_data)}")[m
[31m-            [m
[31m-            # ì‹¤ì œ Supabaseì— ì‹ë‹¨ ë°ì´í„° ì €ì¥[m
[31m-            try:[m
[31m-                from app.core.database import supabase[m
[31m-                from datetime import datetime as dt_module, timedelta[m
[31m-                [m
[31m-                # user_id ê°€ì ¸ì˜¤ê¸° - ì—¬ëŸ¬ ë°©ë²•ìœ¼ë¡œ ì‹œë„[m
[31m-                user_id = None[m
[31m-                [m
[31m-                # 1. profileì—ì„œ í™•ì¸[m
[31m-                if state.get("profile") and state["profile"].get("user_id"):[m
[31m-                    user_id = state["profile"]["user_id"][m
[31m-                    print(f"ğŸ” DEBUG: user_id from profile: {user_id}")[m
[31m-                [m
[31m-                # 2. stateì—ì„œ ì§ì ‘ user_id í™•ì¸[m
[31m-                if not user_id and state.get("user_id"):[m
