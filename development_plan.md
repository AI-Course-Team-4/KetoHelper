# 개발 계획서 - 식당/메뉴 수집 및 키토 점수화 시스템

## 개발 우선순위 및 이유

### 1단계: 데이터 수집 파이프라인 (ETL V0) - **최우선**
- **이유**: 메뉴 점수화를 위한 기초 데이터가 필요
- **목표**: 강남역 다이닝코드에서 식당 ≥20개, 메뉴 ≥80개 수집
- **기간**: 1일 (8시간)
- **주요 작업**:
  - 다이닝코드 크롤러 개발 (`crawl_diningcode.py`)
  - 주소 정규화 및 지오코딩
  - Supabase 적재 스크립트 (`load_to_supabase.py`)
  - 중복 통합 로직 구현

### 2단계: 데이터베이스 스키마 확장 - **필수 전제조건**
- **이유**: 점수화 시스템을 위한 테이블 구조 준비
- **포함**: `keto_scores`, `menu_ingredient` 테이블 확장
- **시간**: 2-3시간
- **주요 작업**:
  - DDL 마이그레이션 실행
  - 인덱스 및 제약조건 추가
  - 기존 스키마와의 연동 확인

### 3단계: 메뉴 점수화 시스템 (키토 점수) - **핵심 기능**
- **이유**: 프로젝트의 핵심 가치 제공
- **목표**: 점수 부여 메뉴 ≥200건, 대체 감지 히트율 ≥60%
- **기간**: 1-2일
- **주요 작업**:
  - 키워드 사전 JSON 파일 생성 (5종)
  - 룰 엔진 및 점수 계산 로직 구현
  - 예외/대체 감지 정규식 개발
  - `keto_scores` 테이블 upsert 로직

### 4단계: 품질 리포트 및 검수 시스템
- **이유**: 운영 품질 관리 필수
- **포함**: CSV 리포트, `needs_review` 큐 생성
- **주요 작업**:
  - 품질 리포트 CSV 생성 (`quality_report_rulekit.csv`)
  - 검수 대상 식별 및 큐 관리
  - 통계 및 분석 기능

### 5단계: 프론트엔드 연동 (선택적)
- **이유**: 사용자 경험 개선
- **포함**: 키토 권장/조건부/비추천 라벨, 추정 배지
- **주요 작업**:
  - UX 라벨 시스템 구현
  - 필터 기능 ("밥/면 제외 가능만 보기")
  - API 엔드포인트 연동

## 핵심 성공 기준

### 데이터 수집 (ETL V0)
- 식당 ≥20개, 메뉴 ≥80개 적재
- 주소 표준화 성공률 ≥90%
- 중복률 ≤2% (캐노니컬 통합 후)
- 전체 파이프라인 30분 이내 완주
- robots.txt/ToS 준수, QPS ≤0.5

### 메뉴 점수화 시스템
- `keto_scores`에 점수 부여 메뉴 ≥200건
- 각 레코드에 `rule_version` 포함
- 대체 감지 히트율 ≥60% (표본 50건 수동 검증)
- `needs_review` 큐 생성 및 CSV 내보내기 정상
- 경계 점수대(35~45) `needs_review=true` 설정

### UX 라벨 시스템
- `score≥80` = **키토 권장**
- `50~79` = **조건부 키토**
- `<50` = **비추천**
- `ingredients_confidence<0.5` = **추정** 배지
- "밥/면 제외 가능만 보기" 필터 기능

## 기술 스택 및 도구

### 데이터 수집
- **언어**: Python
- **HTTP**: httpx + selectolax (기본)
- **동적 렌더**: playwright-python (필요시)
- **지오코딩**: 카카오 REST API
- **데이터베이스**: Supabase Postgres

### 점수화 시스템
- **룰 엔진**: Python 기반 키워드 매칭
- **사전 관리**: JSON 파일 (버전 관리)
- **정규식**: 예외/대체 패턴 감지
- **저장소**: PostgreSQL

## 개발 일정 (권장)

### 1일차: ETL V0 (8시간)
- 0-1h: 시드 URL 수집 및 선택자 테스트
- 1-3h: `crawl_diningcode.py` 완성
- 3-5h: `load_to_supabase.py` 완성
- 5-6h: 리포트/에러 핸들링
- 6-7h: 전체 리허설
- 7-8h: 보완 및 최종 제출

### 2일차: 점수화 시스템 (6-8시간)
- DDL 마이그레이션 적용
- 키워드 사전 JSON 5종 생성
- 룰 엔진 및 점수 계산 로직 구현
- 품질 리포트 시스템 구축

### 3일차: 통합 및 검증 (4-6시간)
- 전체 파이프라인 통합 테스트
- 표본 검증 (50건)
- 프론트엔드 연동 (선택적)
- 최종 품질 검수

## 리스크 및 대응방안

### 기술적 리스크
- **동적 렌더 필요**: 해당 URL 건너뛰기 (playwright 미사용)
- **지오코딩 실패**: null 허용, 리포트로만 집계
- **차단/429**: 서킷 브레이커 발동, 15분 대기

### 데이터 품질 리스크
- **낮은 대체 감지율**: 정규식 패턴 개선
- **높은 중복률**: 캐노니컬 키 로직 보완
- **부정확한 점수**: 키워드 사전 및 가중치 튜닝

## 폴백 계획
- 최소 성공 기준: 식당 10개, 메뉴 50개, 점수화 100건
- 수동 검증 샘플 축소: 50건 → 20건
- 프론트엔드 연동 생략 (더미 데이터로 대체)

## 다음 단계 (V1 이후)
- 소스 확장: 식신 HOT/테마 리스트 추가
- PostGIS 전환 (geometry, GIST 인덱스)
- LLM 보조 점수화
- 식당별 키토 프로필 자동화
- 실시간 추천 API

---

**권장 시작점**: ETL V0부터 시작하여 기초 데이터를 확보한 후, 점수화 시스템을 단계적으로 구축하는 것이 가장 효율적입니다.