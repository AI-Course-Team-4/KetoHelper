<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>키토 식당 지도 테스트</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4e3c17516be4de85ba035c3e30793cc0&libraries=services&autoload=false"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #45a049;
        }
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        .info-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .map-container {
            height: 500px;
            width: 100%;
            position: relative;
        }
        .restaurant-list {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eee;
        }
        .restaurant-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .restaurant-item:hover {
            background-color: #f0f0f0;
        }
        .restaurant-item.selected {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        .restaurant-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .restaurant-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .keto-score {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .score-excellent { background-color: #4CAF50; }
        .score-good { background-color: #FF9800; }
        .score-fair { background-color: #FF5722; }
        .score-poor { background-color: #f44336; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍖 키토 식당 지도 테스트</h1>
            <p>내 위치 중심으로 키토 점수 10점 이상 식당 찾기</p>
        </div>
        
        <div class="controls">
            <button onclick="getCurrentLocation()">📍 내 위치 가져오기</button>
            <button onclick="searchKetoRestaurants()" id="searchBtn" disabled>🔍 키토 식당 검색</button>
            <button onclick="clearMap()">🗑️ 지도 초기화</button>
            <button onclick="testAPI()" style="background: #2196F3;">🧪 API 테스트 (강남역)</button>
            <button onclick="testAPIHongdae()" style="background: #FF9800;">🎵 홍대 테스트</button>
            <button onclick="testAPIGangbuk()" style="background: #4CAF50;">🏢 강북 테스트</button>
            <button onclick="testAPIBusan()" style="background: #9C27B0;">🌊 부산 테스트</button>
            <button onclick="showDetailedAPIResponse()" style="background: #9C27B0;">📋 API 응답 상세 확인</button>
            <div style="margin-left: auto;">
                <label>최소 키토 점수: </label>
                <input type="number" id="minScore" value="30" min="0" max="100" style="width: 60px; padding: 5px;">
                <label>검색 반경: </label>
                <select id="radius" style="padding: 5px;">
                    <option value="1000">1km</option>
                    <option value="2000" selected>2km</option>
                    <option value="3000">3km</option>
                    <option value="5000">5km</option>
                </select>
            </div>
        </div>
        
        <div class="info">
            <div class="info-item"><strong>현재 위치:</strong> <span id="currentLocation">위치를 가져오세요</span></div>
            <div class="info-item"><strong>발견된 식당:</strong> <span id="restaurantCount">0개</span></div>
            <div class="info-item"><strong>검색 상태:</strong> <span id="searchStatus">대기 중</span></div>
            <div class="info-item"><strong>지도 상태:</strong> <span id="mapStatus">로딩 중...</span></div>
        </div>
        
        <div style="display: flex;">
            <div style="flex: 2;">
                <div id="map" class="map-container"></div>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <div class="restaurant-list" id="restaurantList">
                    <div class="loading">식당을 검색해보세요!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let userLocation = null;
        let restaurants = [];
        let markers = [];
        let userMarker = null;

        // 카카오 지도 초기화
        function initMap() {
            if (typeof kakao === 'undefined') {
                document.getElementById('searchStatus').textContent = '카카오 지도 API 로드 실패';
                return;
            }

            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.4979, 127.0276), // 강남역 기본 위치
                level: 3
            };
            
            map = new kakao.maps.Map(container, options);
            console.log('지도 초기화 완료');
        }

        // 현재 위치 가져오기
        function getCurrentLocation() {
            document.getElementById('searchStatus').textContent = '위치 가져오는 중...';
            
            if (!navigator.geolocation) {
                alert('이 브라우저에서는 위치 서비스를 지원하지 않습니다.');
                document.getElementById('searchStatus').textContent = '위치 서비스 미지원';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    console.log('위치 가져오기 성공:', userLocation);
                    
                    // 지도가 초기화되었는지 확인
                    if (map && typeof kakao !== 'undefined') {
                        // 지도 중심을 사용자 위치로 이동
                        const moveLatLon = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                        map.setCenter(moveLatLon);
                        
                        // 사용자 위치 마커 표시
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        
                        const userImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                        const userImageSize = new kakao.maps.Size(24, 35);
                        const userMarkerImage = new kakao.maps.MarkerImage(userImageSrc, userImageSize);
                        
                        userMarker = new kakao.maps.Marker({
                            position: moveLatLon,
                            image: userMarkerImage,
                            title: '내 위치'
                        });
                        userMarker.setMap(map);
                    }
                    
                    // 위치 정보 업데이트
                    document.getElementById('currentLocation').textContent = 
                        `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                    document.getElementById('searchStatus').textContent = '위치 가져오기 완료';
                    
                    // 검색 버튼 활성화
                    document.getElementById('searchBtn').disabled = false;
                    
                    console.log('사용자 위치:', userLocation);
                },
                function(error) {
                    console.error('위치 가져오기 실패:', error);
                    document.getElementById('searchStatus').textContent = '위치 가져오기 실패';
                    
                    let errorMessage = '위치 정보를 가져올 수 없습니다.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '위치 접근이 거부되었습니다. 브라우저 설정을 확인해주세요.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '위치 정보를 사용할 수 없습니다.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '위치 요청 시간이 초과되었습니다.';
                            break;
                    }
                    
                    alert(errorMessage + ' 기본 위치(강남역)를 사용합니다.');
                    
                    userLocation = { lat: 37.4979, lng: 127.0276 };
                    document.getElementById('currentLocation').textContent = '강남역 (기본 위치)';
                    document.getElementById('searchBtn').disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,  // 타임아웃 증가
                    maximumAge: 300000
                }
            );
        }

        // 키토 식당 검색
        async function searchKetoRestaurants() {
            if (!userLocation) {
                alert('먼저 위치를 가져오세요!');
                return;
            }

            document.getElementById('searchStatus').textContent = '식당 검색 중...';
            document.getElementById('searchBtn').disabled = true;
            
            // 기존 마커들 제거
            clearMarkers();
            
            const minScore = document.getElementById('minScore').value;
            const radius = document.getElementById('radius').value;
            
            try {
                // 백엔드 API 호출
                const response = await fetch(
                    `http://localhost:8000/api/v1/places/high-keto-score?lat=${userLocation.lat}&lng=${userLocation.lng}&min_score=${minScore}&radius=${radius}&max_results=10`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API 응답:', data);
                
                restaurants = data.places || [];
                
                // 결과 표시
                displayRestaurants(restaurants);
                displayMarkers(restaurants);
                
                document.getElementById('restaurantCount').textContent = `${restaurants.length}개`;
                
                // 하이브리드 검색 결과 표시
                let statusText = `검색 완료 (${restaurants.length}개 발견)`;
                if (data.search_method) {
                    statusText += ` - ${data.search_method === 'database_only' ? 'DB 전용' : '하이브리드'}`;
                }
                if (data.db_count !== undefined && data.kakao_count !== undefined) {
                    statusText += ` [DB: ${data.db_count}개, 카카오: ${data.kakao_count}개]`;
                }
                document.getElementById('searchStatus').textContent = statusText;
                
            } catch (error) {
                console.error('검색 오류:', error);
                document.getElementById('searchStatus').textContent = '검색 실패';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">검색 중 오류가 발생했습니다: ${error.message}</div>`;
            } finally {
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // 식당 목록 표시
        function displayRestaurants(restaurants) {
            const listContainer = document.getElementById('restaurantList');
            
            if (restaurants.length === 0) {
                listContainer.innerHTML = '<div class="loading">검색된 식당이 없습니다.</div>';
                return;
            }
            
            listContainer.innerHTML = restaurants.map((restaurant, index) => {
                const scoreClass = getScoreClass(restaurant.keto_score);
                return `
                    <div class="restaurant-item" onclick="selectRestaurant(${index})">
                        <div class="restaurant-name">${restaurant.name}</div>
                        <div class="restaurant-info">${restaurant.address}</div>
                        <div class="restaurant-info">카테고리: ${restaurant.category || '미분류'}</div>
                        <div>
                            <span class="keto-score ${scoreClass}">키토 ${restaurant.keto_score}점</span>
                        </div>
                        ${restaurant.why && restaurant.why.length > 0 ? 
                            `<div class="restaurant-info">이유: ${restaurant.why.join(', ')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // 마커 표시
        function displayMarkers(restaurants) {
            // 카카오 API가 로드되지 않은 경우 마커 표시 생략
            if (typeof kakao === 'undefined' || !map) {
                console.log('카카오 API가 로드되지 않아 마커를 표시할 수 없습니다.');
                return;
            }
            
            restaurants.forEach((restaurant, index) => {
                if (restaurant.lat && restaurant.lng) {
                    const position = new kakao.maps.LatLng(restaurant.lat, restaurant.lng);
                    
                    // 기본 마커 사용 (이미지 없이)
                    const marker = new kakao.maps.Marker({
                        position: position,
                        title: restaurant.name
                    });
                    
                    marker.setMap(map);
                    markers.push(marker);
                    
                    // 마커 클릭 이벤트
                    kakao.maps.event.addListener(marker, 'click', function() {
                        selectRestaurant(index);
                    });
                }
            });
            
            // 모든 마커가 보이도록 지도 범위 조정
            if (markers.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                if (userMarker) {
                    bounds.extend(userMarker.getPosition());
                }
                map.setBounds(bounds);
            }
        }

        // 식당 선택
        function selectRestaurant(index) {
            // 이전 선택 제거
            document.querySelectorAll('.restaurant-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // 현재 선택 표시
            const items = document.querySelectorAll('.restaurant-item');
            if (items[index]) {
                items[index].classList.add('selected');
            }
            
            // 지도가 있고 카카오 API가 로드된 경우에만 지도 이동
            const restaurant = restaurants[index];
            if (restaurant.lat && restaurant.lng && map && typeof kakao !== 'undefined') {
                const position = new kakao.maps.LatLng(restaurant.lat, restaurant.lng);
                map.setCenter(position);
                map.setLevel(2);
            }
        }

        // 점수별 CSS 클래스
        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            if (score >= 40) return 'score-fair';
            return 'score-poor';
        }

        // 점수별 마커 이미지 (기본 마커 사용)
        function getMarkerImage(score) {
            // 카카오 맵 기본 마커 사용 (이미지 없이)
            return null;
        }

        // 마커 제거
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }

        // 지도 초기화
        function clearMap() {
            clearMarkers();
            if (userMarker && map) {
                userMarker.setMap(null);
                userMarker = null;
            }
            restaurants = [];
            document.getElementById('restaurantList').innerHTML = '<div class="loading">식당을 검색해보세요!</div>';
            document.getElementById('restaurantCount').textContent = '0개';
            document.getElementById('searchStatus').textContent = '대기 중';
            
            // 지도가 있을 때만 리셋
            if (map && typeof kakao !== 'undefined') {
                const moveLatLon = new kakao.maps.LatLng(37.4979, 127.0276);
                map.setCenter(moveLatLon);
                map.setLevel(3);
            }
        }

        // API 테스트 함수 (지도 없이도 테스트 가능)
        async function testAPI() {
            await runAPITest('강남역', { lat: 37.4979, lng: 127.0276 });
        }
        
        async function testAPIHongdae() {
            await runAPITest('홍대', { lat: 37.5563, lng: 126.9226 });
        }
        
        async function testAPIGangbuk() {
            await runAPITest('강북', { lat: 37.6396, lng: 127.0253 });
        }
        
        async function testAPIBusan() {
            await runAPITest('부산 해운대', { lat: 35.1587, lng: 129.1603 });
        }
        

        // API 응답 상세 확인
        async function showDetailedAPIResponse() {
            document.getElementById('searchStatus').textContent = 'API 응답 상세 분석 중...';
            
            try {
                const minScore = document.getElementById('minScore').value;
                const radius = document.getElementById('radius').value;
                
                // 강남역 좌표로 테스트
                const lat = 37.4979;
                const lng = 127.0276;
                
                const url = `http://localhost:8000/api/v1/places/high-keto-score?lat=${lat}&lng=${lng}&min_score=${minScore}&radius=${radius}&max_results=10`;
                
                console.log('🔍 API 요청 URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('📋 전체 API 응답:', data);
                
                // 상세 정보 표시
                let detail = '📋 API 응답 상세 정보:\n\n';
                detail += `🔍 검색 방법: ${data.search_method}\n`;
                detail += `📍 사용자 위치: (${data.user_location.lat}, ${data.user_location.lng})\n`;
                detail += `📏 검색 반경: ${data.search_radius}m\n`;
                detail += `📊 최소 키토 점수: ${data.min_score}점\n`;
                detail += `📈 총 발견: ${data.total_found}개\n`;
                detail += `🗄️ DB 결과: ${data.db_count}개\n`;
                detail += `🌐 카카오 API: ${data.kakao_count}개\n\n`;
                
                detail += `🍽️ 식당 목록 (${data.places.length}개):\n`;
                detail += '=' + '='.repeat(50) + '\n';
                
                data.places.forEach((place, index) => {
                    detail += `\n${index + 1}. ${place.name}\n`;
                    detail += `   📍 주소: ${place.address}\n`;
                    detail += `   🏷️ 카테고리: ${place.category}\n`;
                    detail += `   📍 좌표: (${place.lat}, ${place.lng})\n`;
                    detail += `   ⭐ 키토 점수: ${place.keto_score}점\n`;
                    detail += `   💡 이유: ${place.why.join(', ')}\n`;
                    detail += `   💭 팁: ${place.tips.join(', ')}\n`;
                    detail += `   🆔 ID: ${place.place_id}\n`;
                    detail += '-'.repeat(50) + '\n';
                });
                
                // 화면에 표시
                document.getElementById('searchStatus').textContent = 'API 응답 분석 완료';
                document.getElementById('restaurantList').innerHTML = `<pre style="white-space: pre-wrap; font-size: 12px; max-height: 600px; overflow-y: auto;">${detail}</pre>`;
                
                // 간단한 요약도 alert로 표시
                const summary = `📋 API 응답 요약:\n\n` +
                              `• 총 ${data.places.length}개 식당 발견\n` +
                              `• 검색 방법: ${data.search_method}\n` +
                              `• 최고 점수: ${Math.max(...data.places.map(p => p.keto_score))}점\n` +
                              `• DB: ${data.db_count}개, 카카오: ${data.kakao_count}개`;
                
                alert(summary);
                      
            } catch (error) {
                console.error('❌ API 응답 확인 실패:', error);
                document.getElementById('searchStatus').textContent = 'API 응답 확인 실패';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">API 응답 확인 중 오류가 발생했습니다: ${error.message}</div>`;
            }
        }
        
        async function runAPITest(locationName, testLocation) {
            document.getElementById('searchStatus').textContent = `${locationName} API 테스트 중...`;
            
            const minScore = document.getElementById('minScore').value;
            const radius = document.getElementById('radius').value;
            
            try {
                console.log(`${locationName} API 테스트 시작:`, testLocation);
                
                const response = await fetch(
                    `http://localhost:8000/api/v1/places/high-keto-score?lat=${testLocation.lat}&lng=${testLocation.lng}&min_score=${minScore}&radius=${radius}&max_results=10`
                );
                
                console.log('API 응답 상태:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API 응답 데이터:', data);
                
                restaurants = data.places || [];
                
                // 결과 표시 (지도 없이)
                displayRestaurants(restaurants);
                
                document.getElementById('restaurantCount').textContent = `${restaurants.length}개`;
                
                // 하이브리드 검색 결과 표시
                let testResult = `${locationName} 테스트 완료 (${restaurants.length}개 발견)`;
                if (data.search_method) {
                    testResult += ` - ${data.search_method === 'database_only' ? 'DB 전용' : '하이브리드'}`;
                }
                if (data.db_count !== undefined && data.kakao_count !== undefined) {
                    testResult += ` [DB: ${data.db_count}개, 카카오: ${data.kakao_count}개]`;
                }
                
                document.getElementById('searchStatus').textContent = testResult;
                document.getElementById('currentLocation').textContent = `${locationName} 테스트 (${testLocation.lat}, ${testLocation.lng})`;
                
                // 지도가 있으면 마커도 표시하고 중심 이동
                if (map && typeof kakao !== 'undefined') {
                    displayMarkers(restaurants);
                    const moveLatLon = new kakao.maps.LatLng(testLocation.lat, testLocation.lng);
                    map.setCenter(moveLatLon);
                    map.setLevel(3);
                }
                
            } catch (error) {
                console.error('API 테스트 오류:', error);
                document.getElementById('searchStatus').textContent = 'API 테스트 실패';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">API 테스트 중 오류가 발생했습니다: ${error.message}<br>
                    백엔드 서버가 실행 중인지 확인해주세요. (http://localhost:8000)</div>`;
            }
        }

        // 카카오 API 수동 로드
        function loadKakaoMap() {
            if (typeof kakao !== 'undefined') {
                kakao.maps.load(function() {
                    console.log('카카오 지도 API 로드 완료');
                    document.getElementById('mapStatus').textContent = '카카오 지도 로드 완료';
                    initMap();
                });
            } else {
                console.error('카카오 객체를 찾을 수 없습니다');
                document.getElementById('mapStatus').textContent = '카카오 지도 API 로드 실패';
                document.getElementById('searchStatus').textContent = '카카오 지도 API 로드 실패';
            }
        }

        // 페이지 로드 시 지도 초기화
        window.onload = function() {
            console.log('페이지 로드 완료');
            
            // 약간의 지연 후 카카오 API 로드 시도
            setTimeout(() => {
                loadKakaoMap();
            }, 1000);
        };
    </script>
</body>
</html>
