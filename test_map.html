<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í‚¤í†  ì‹ë‹¹ ì§€ë„ í…ŒìŠ¤íŠ¸</title>
    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=4e3c17516be4de85ba035c3e30793cc0&libraries=services&autoload=false"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: #4CAF50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background: #45a049;
        }
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info {
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        .info-item {
            margin: 5px 0;
            padding: 5px;
            background: white;
            border-radius: 3px;
        }
        .map-container {
            height: 500px;
            width: 100%;
            position: relative;
        }
        .restaurant-list {
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eee;
        }
        .restaurant-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .restaurant-item:hover {
            background-color: #f0f0f0;
        }
        .restaurant-item.selected {
            background-color: #e8f5e8;
            border-left: 4px solid #4CAF50;
        }
        .restaurant-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .restaurant-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        .keto-score {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .score-excellent { background-color: #4CAF50; }
        .score-good { background-color: #FF9800; }
        .score-fair { background-color: #FF5722; }
        .score-poor { background-color: #f44336; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ– í‚¤í†  ì‹ë‹¹ ì§€ë„ í…ŒìŠ¤íŠ¸</h1>
            <p>ë‚´ ìœ„ì¹˜ ì¤‘ì‹¬ìœ¼ë¡œ í‚¤í†  ì ìˆ˜ 10ì  ì´ìƒ ì‹ë‹¹ ì°¾ê¸°</p>
        </div>
        
        <div class="controls">
            <button onclick="getCurrentLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°</button>
            <button onclick="searchKetoRestaurants()" id="searchBtn" disabled>ğŸ” í‚¤í†  ì‹ë‹¹ ê²€ìƒ‰</button>
            <button onclick="clearMap()">ğŸ—‘ï¸ ì§€ë„ ì´ˆê¸°í™”</button>
            <button onclick="testAPI()" style="background: #2196F3;">ğŸ§ª API í…ŒìŠ¤íŠ¸ (ê°•ë‚¨ì—­)</button>
            <button onclick="testAPIHongdae()" style="background: #FF9800;">ğŸµ í™ëŒ€ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testAPIGangbuk()" style="background: #4CAF50;">ğŸ¢ ê°•ë¶ í…ŒìŠ¤íŠ¸</button>
            <button onclick="testAPIBusan()" style="background: #9C27B0;">ğŸŒŠ ë¶€ì‚° í…ŒìŠ¤íŠ¸</button>
            <button onclick="showDetailedAPIResponse()" style="background: #9C27B0;">ğŸ“‹ API ì‘ë‹µ ìƒì„¸ í™•ì¸</button>
            <div style="margin-left: auto;">
                <label>ìµœì†Œ í‚¤í†  ì ìˆ˜: </label>
                <input type="number" id="minScore" value="30" min="0" max="100" style="width: 60px; padding: 5px;">
                <label>ê²€ìƒ‰ ë°˜ê²½: </label>
                <select id="radius" style="padding: 5px;">
                    <option value="1000">1km</option>
                    <option value="2000" selected>2km</option>
                    <option value="3000">3km</option>
                    <option value="5000">5km</option>
                </select>
            </div>
        </div>
        
        <div class="info">
            <div class="info-item"><strong>í˜„ì¬ ìœ„ì¹˜:</strong> <span id="currentLocation">ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”</span></div>
            <div class="info-item"><strong>ë°œê²¬ëœ ì‹ë‹¹:</strong> <span id="restaurantCount">0ê°œ</span></div>
            <div class="info-item"><strong>ê²€ìƒ‰ ìƒíƒœ:</strong> <span id="searchStatus">ëŒ€ê¸° ì¤‘</span></div>
            <div class="info-item"><strong>ì§€ë„ ìƒíƒœ:</strong> <span id="mapStatus">ë¡œë”© ì¤‘...</span></div>
        </div>
        
        <div style="display: flex;">
            <div style="flex: 2;">
                <div id="map" class="map-container"></div>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <div class="restaurant-list" id="restaurantList">
                    <div class="loading">ì‹ë‹¹ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map = null;
        let userLocation = null;
        let restaurants = [];
        let markers = [];
        let userMarker = null;

        // ì¹´ì¹´ì˜¤ ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            if (typeof kakao === 'undefined') {
                document.getElementById('searchStatus').textContent = 'ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨';
                return;
            }

            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.4979, 127.0276), // ê°•ë‚¨ì—­ ê¸°ë³¸ ìœ„ì¹˜
                level: 3
            };
            
            map = new kakao.maps.Map(container, options);
            console.log('ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ');
        }

        // í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        function getCurrentLocation() {
            document.getElementById('searchStatus').textContent = 'ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
            
            if (!navigator.geolocation) {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                document.getElementById('searchStatus').textContent = 'ìœ„ì¹˜ ì„œë¹„ìŠ¤ ë¯¸ì§€ì›';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    console.log('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ:', userLocation);
                    
                    // ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (map && typeof kakao !== 'undefined') {
                        // ì§€ë„ ì¤‘ì‹¬ì„ ì‚¬ìš©ì ìœ„ì¹˜ë¡œ ì´ë™
                        const moveLatLon = new kakao.maps.LatLng(userLocation.lat, userLocation.lng);
                        map.setCenter(moveLatLon);
                        
                        // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
                        if (userMarker) {
                            userMarker.setMap(null);
                        }
                        
                        const userImageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                        const userImageSize = new kakao.maps.Size(24, 35);
                        const userMarkerImage = new kakao.maps.MarkerImage(userImageSrc, userImageSize);
                        
                        userMarker = new kakao.maps.Marker({
                            position: moveLatLon,
                            image: userMarkerImage,
                            title: 'ë‚´ ìœ„ì¹˜'
                        });
                        userMarker.setMap(map);
                    }
                    
                    // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
                    document.getElementById('currentLocation').textContent = 
                        `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
                    document.getElementById('searchStatus').textContent = 'ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ';
                    
                    // ê²€ìƒ‰ ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('searchBtn').disabled = false;
                    
                    console.log('ì‚¬ìš©ì ìœ„ì¹˜:', userLocation);
                },
                function(error) {
                    console.error('ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    document.getElementById('searchStatus').textContent = 'ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨';
                    
                    let errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
                            break;
                    }
                    
                    alert(errorMessage + ' ê¸°ë³¸ ìœ„ì¹˜(ê°•ë‚¨ì—­)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                    
                    userLocation = { lat: 37.4979, lng: 127.0276 };
                    document.getElementById('currentLocation').textContent = 'ê°•ë‚¨ì—­ (ê¸°ë³¸ ìœ„ì¹˜)';
                    document.getElementById('searchBtn').disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,  // íƒ€ì„ì•„ì›ƒ ì¦ê°€
                    maximumAge: 300000
                }
            );
        }

        // í‚¤í†  ì‹ë‹¹ ê²€ìƒ‰
        async function searchKetoRestaurants() {
            if (!userLocation) {
                alert('ë¨¼ì € ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”!');
                return;
            }

            document.getElementById('searchStatus').textContent = 'ì‹ë‹¹ ê²€ìƒ‰ ì¤‘...';
            document.getElementById('searchBtn').disabled = true;
            
            // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
            clearMarkers();
            
            const minScore = document.getElementById('minScore').value;
            const radius = document.getElementById('radius').value;
            
            try {
                // ë°±ì—”ë“œ API í˜¸ì¶œ
                const response = await fetch(
                    `http://localhost:8000/api/v1/places/high-keto-score?lat=${userLocation.lat}&lng=${userLocation.lng}&min_score=${minScore}&radius=${radius}&max_results=10`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API ì‘ë‹µ:', data);
                
                restaurants = data.places || [];
                
                // ê²°ê³¼ í‘œì‹œ
                displayRestaurants(restaurants);
                displayMarkers(restaurants);
                
                document.getElementById('restaurantCount').textContent = `${restaurants.length}ê°œ`;
                
                // í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                let statusText = `ê²€ìƒ‰ ì™„ë£Œ (${restaurants.length}ê°œ ë°œê²¬)`;
                if (data.search_method) {
                    statusText += ` - ${data.search_method === 'database_only' ? 'DB ì „ìš©' : 'í•˜ì´ë¸Œë¦¬ë“œ'}`;
                }
                if (data.db_count !== undefined && data.kakao_count !== undefined) {
                    statusText += ` [DB: ${data.db_count}ê°œ, ì¹´ì¹´ì˜¤: ${data.kakao_count}ê°œ]`;
                }
                document.getElementById('searchStatus').textContent = statusText;
                
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                document.getElementById('searchStatus').textContent = 'ê²€ìƒ‰ ì‹¤íŒ¨';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            } finally {
                document.getElementById('searchBtn').disabled = false;
            }
        }

        // ì‹ë‹¹ ëª©ë¡ í‘œì‹œ
        function displayRestaurants(restaurants) {
            const listContainer = document.getElementById('restaurantList');
            
            if (restaurants.length === 0) {
                listContainer.innerHTML = '<div class="loading">ê²€ìƒ‰ëœ ì‹ë‹¹ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            listContainer.innerHTML = restaurants.map((restaurant, index) => {
                const scoreClass = getScoreClass(restaurant.keto_score);
                return `
                    <div class="restaurant-item" onclick="selectRestaurant(${index})">
                        <div class="restaurant-name">${restaurant.name}</div>
                        <div class="restaurant-info">${restaurant.address}</div>
                        <div class="restaurant-info">ì¹´í…Œê³ ë¦¬: ${restaurant.category || 'ë¯¸ë¶„ë¥˜'}</div>
                        <div>
                            <span class="keto-score ${scoreClass}">í‚¤í†  ${restaurant.keto_score}ì </span>
                        </div>
                        ${restaurant.why && restaurant.why.length > 0 ? 
                            `<div class="restaurant-info">ì´ìœ : ${restaurant.why.join(', ')}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ë§ˆì»¤ í‘œì‹œ
        function displayMarkers(restaurants) {
            // ì¹´ì¹´ì˜¤ APIê°€ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ë§ˆì»¤ í‘œì‹œ ìƒëµ
            if (typeof kakao === 'undefined' || !map) {
                console.log('ì¹´ì¹´ì˜¤ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•„ ë§ˆì»¤ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            restaurants.forEach((restaurant, index) => {
                if (restaurant.lat && restaurant.lng) {
                    const position = new kakao.maps.LatLng(restaurant.lat, restaurant.lng);
                    
                    // ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš© (ì´ë¯¸ì§€ ì—†ì´)
                    const marker = new kakao.maps.Marker({
                        position: position,
                        title: restaurant.name
                    });
                    
                    marker.setMap(map);
                    markers.push(marker);
                    
                    // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                    kakao.maps.event.addListener(marker, 'click', function() {
                        selectRestaurant(index);
                    });
                }
            });
            
            // ëª¨ë“  ë§ˆì»¤ê°€ ë³´ì´ë„ë¡ ì§€ë„ ë²”ìœ„ ì¡°ì •
            if (markers.length > 0) {
                const bounds = new kakao.maps.LatLngBounds();
                markers.forEach(marker => {
                    bounds.extend(marker.getPosition());
                });
                if (userMarker) {
                    bounds.extend(userMarker.getPosition());
                }
                map.setBounds(bounds);
            }
        }

        // ì‹ë‹¹ ì„ íƒ
        function selectRestaurant(index) {
            // ì´ì „ ì„ íƒ ì œê±°
            document.querySelectorAll('.restaurant-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // í˜„ì¬ ì„ íƒ í‘œì‹œ
            const items = document.querySelectorAll('.restaurant-item');
            if (items[index]) {
                items[index].classList.add('selected');
            }
            
            // ì§€ë„ê°€ ìˆê³  ì¹´ì¹´ì˜¤ APIê°€ ë¡œë“œëœ ê²½ìš°ì—ë§Œ ì§€ë„ ì´ë™
            const restaurant = restaurants[index];
            if (restaurant.lat && restaurant.lng && map && typeof kakao !== 'undefined') {
                const position = new kakao.maps.LatLng(restaurant.lat, restaurant.lng);
                map.setCenter(position);
                map.setLevel(2);
            }
        }

        // ì ìˆ˜ë³„ CSS í´ë˜ìŠ¤
        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 60) return 'score-good';
            if (score >= 40) return 'score-fair';
            return 'score-poor';
        }

        // ì ìˆ˜ë³„ ë§ˆì»¤ ì´ë¯¸ì§€ (ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš©)
        function getMarkerImage(score) {
            // ì¹´ì¹´ì˜¤ ë§µ ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš© (ì´ë¯¸ì§€ ì—†ì´)
            return null;
        }

        // ë§ˆì»¤ ì œê±°
        function clearMarkers() {
            markers.forEach(marker => {
                marker.setMap(null);
            });
            markers = [];
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function clearMap() {
            clearMarkers();
            if (userMarker && map) {
                userMarker.setMap(null);
                userMarker = null;
            }
            restaurants = [];
            document.getElementById('restaurantList').innerHTML = '<div class="loading">ì‹ë‹¹ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”!</div>';
            document.getElementById('restaurantCount').textContent = '0ê°œ';
            document.getElementById('searchStatus').textContent = 'ëŒ€ê¸° ì¤‘';
            
            // ì§€ë„ê°€ ìˆì„ ë•Œë§Œ ë¦¬ì…‹
            if (map && typeof kakao !== 'undefined') {
                const moveLatLon = new kakao.maps.LatLng(37.4979, 127.0276);
                map.setCenter(moveLatLon);
                map.setLevel(3);
            }
        }

        // API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ (ì§€ë„ ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥)
        async function testAPI() {
            await runAPITest('ê°•ë‚¨ì—­', { lat: 37.4979, lng: 127.0276 });
        }
        
        async function testAPIHongdae() {
            await runAPITest('í™ëŒ€', { lat: 37.5563, lng: 126.9226 });
        }
        
        async function testAPIGangbuk() {
            await runAPITest('ê°•ë¶', { lat: 37.6396, lng: 127.0253 });
        }
        
        async function testAPIBusan() {
            await runAPITest('ë¶€ì‚° í•´ìš´ëŒ€', { lat: 35.1587, lng: 129.1603 });
        }
        

        // API ì‘ë‹µ ìƒì„¸ í™•ì¸
        async function showDetailedAPIResponse() {
            document.getElementById('searchStatus').textContent = 'API ì‘ë‹µ ìƒì„¸ ë¶„ì„ ì¤‘...';
            
            try {
                const minScore = document.getElementById('minScore').value;
                const radius = document.getElementById('radius').value;
                
                // ê°•ë‚¨ì—­ ì¢Œí‘œë¡œ í…ŒìŠ¤íŠ¸
                const lat = 37.4979;
                const lng = 127.0276;
                
                const url = `http://localhost:8000/api/v1/places/high-keto-score?lat=${lat}&lng=${lng}&min_score=${minScore}&radius=${radius}&max_results=10`;
                
                console.log('ğŸ” API ìš”ì²­ URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('ğŸ“‹ ì „ì²´ API ì‘ë‹µ:', data);
                
                // ìƒì„¸ ì •ë³´ í‘œì‹œ
                let detail = 'ğŸ“‹ API ì‘ë‹µ ìƒì„¸ ì •ë³´:\n\n';
                detail += `ğŸ” ê²€ìƒ‰ ë°©ë²•: ${data.search_method}\n`;
                detail += `ğŸ“ ì‚¬ìš©ì ìœ„ì¹˜: (${data.user_location.lat}, ${data.user_location.lng})\n`;
                detail += `ğŸ“ ê²€ìƒ‰ ë°˜ê²½: ${data.search_radius}m\n`;
                detail += `ğŸ“Š ìµœì†Œ í‚¤í†  ì ìˆ˜: ${data.min_score}ì \n`;
                detail += `ğŸ“ˆ ì´ ë°œê²¬: ${data.total_found}ê°œ\n`;
                detail += `ğŸ—„ï¸ DB ê²°ê³¼: ${data.db_count}ê°œ\n`;
                detail += `ğŸŒ ì¹´ì¹´ì˜¤ API: ${data.kakao_count}ê°œ\n\n`;
                
                detail += `ğŸ½ï¸ ì‹ë‹¹ ëª©ë¡ (${data.places.length}ê°œ):\n`;
                detail += '=' + '='.repeat(50) + '\n';
                
                data.places.forEach((place, index) => {
                    detail += `\n${index + 1}. ${place.name}\n`;
                    detail += `   ğŸ“ ì£¼ì†Œ: ${place.address}\n`;
                    detail += `   ğŸ·ï¸ ì¹´í…Œê³ ë¦¬: ${place.category}\n`;
                    detail += `   ğŸ“ ì¢Œí‘œ: (${place.lat}, ${place.lng})\n`;
                    detail += `   â­ í‚¤í†  ì ìˆ˜: ${place.keto_score}ì \n`;
                    detail += `   ğŸ’¡ ì´ìœ : ${place.why.join(', ')}\n`;
                    detail += `   ğŸ’­ íŒ: ${place.tips.join(', ')}\n`;
                    detail += `   ğŸ†” ID: ${place.place_id}\n`;
                    detail += '-'.repeat(50) + '\n';
                });
                
                // í™”ë©´ì— í‘œì‹œ
                document.getElementById('searchStatus').textContent = 'API ì‘ë‹µ ë¶„ì„ ì™„ë£Œ';
                document.getElementById('restaurantList').innerHTML = `<pre style="white-space: pre-wrap; font-size: 12px; max-height: 600px; overflow-y: auto;">${detail}</pre>`;
                
                // ê°„ë‹¨í•œ ìš”ì•½ë„ alertë¡œ í‘œì‹œ
                const summary = `ğŸ“‹ API ì‘ë‹µ ìš”ì•½:\n\n` +
                              `â€¢ ì´ ${data.places.length}ê°œ ì‹ë‹¹ ë°œê²¬\n` +
                              `â€¢ ê²€ìƒ‰ ë°©ë²•: ${data.search_method}\n` +
                              `â€¢ ìµœê³  ì ìˆ˜: ${Math.max(...data.places.map(p => p.keto_score))}ì \n` +
                              `â€¢ DB: ${data.db_count}ê°œ, ì¹´ì¹´ì˜¤: ${data.kakao_count}ê°œ`;
                
                alert(summary);
                      
            } catch (error) {
                console.error('âŒ API ì‘ë‹µ í™•ì¸ ì‹¤íŒ¨:', error);
                document.getElementById('searchStatus').textContent = 'API ì‘ë‹µ í™•ì¸ ì‹¤íŒ¨';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">API ì‘ë‹µ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            }
        }
        
        async function runAPITest(locationName, testLocation) {
            document.getElementById('searchStatus').textContent = `${locationName} API í…ŒìŠ¤íŠ¸ ì¤‘...`;
            
            const minScore = document.getElementById('minScore').value;
            const radius = document.getElementById('radius').value;
            
            try {
                console.log(`${locationName} API í…ŒìŠ¤íŠ¸ ì‹œì‘:`, testLocation);
                
                const response = await fetch(
                    `http://localhost:8000/api/v1/places/high-keto-score?lat=${testLocation.lat}&lng=${testLocation.lng}&min_score=${minScore}&radius=${radius}&max_results=10`
                );
                
                console.log('API ì‘ë‹µ ìƒíƒœ:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API ì‘ë‹µ ë°ì´í„°:', data);
                
                restaurants = data.places || [];
                
                // ê²°ê³¼ í‘œì‹œ (ì§€ë„ ì—†ì´)
                displayRestaurants(restaurants);
                
                document.getElementById('restaurantCount').textContent = `${restaurants.length}ê°œ`;
                
                // í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                let testResult = `${locationName} í…ŒìŠ¤íŠ¸ ì™„ë£Œ (${restaurants.length}ê°œ ë°œê²¬)`;
                if (data.search_method) {
                    testResult += ` - ${data.search_method === 'database_only' ? 'DB ì „ìš©' : 'í•˜ì´ë¸Œë¦¬ë“œ'}`;
                }
                if (data.db_count !== undefined && data.kakao_count !== undefined) {
                    testResult += ` [DB: ${data.db_count}ê°œ, ì¹´ì¹´ì˜¤: ${data.kakao_count}ê°œ]`;
                }
                
                document.getElementById('searchStatus').textContent = testResult;
                document.getElementById('currentLocation').textContent = `${locationName} í…ŒìŠ¤íŠ¸ (${testLocation.lat}, ${testLocation.lng})`;
                
                // ì§€ë„ê°€ ìˆìœ¼ë©´ ë§ˆì»¤ë„ í‘œì‹œí•˜ê³  ì¤‘ì‹¬ ì´ë™
                if (map && typeof kakao !== 'undefined') {
                    displayMarkers(restaurants);
                    const moveLatLon = new kakao.maps.LatLng(testLocation.lat, testLocation.lng);
                    map.setCenter(moveLatLon);
                    map.setLevel(3);
                }
                
            } catch (error) {
                console.error('API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                document.getElementById('searchStatus').textContent = 'API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨';
                document.getElementById('restaurantList').innerHTML = 
                    `<div class="error">API í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}<br>
                    ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”. (http://localhost:8000)</div>`;
            }
        }

        // ì¹´ì¹´ì˜¤ API ìˆ˜ë™ ë¡œë“œ
        function loadKakaoMap() {
            if (typeof kakao !== 'undefined') {
                kakao.maps.load(function() {
                    console.log('ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì™„ë£Œ');
                    document.getElementById('mapStatus').textContent = 'ì¹´ì¹´ì˜¤ ì§€ë„ ë¡œë“œ ì™„ë£Œ';
                    initMap();
                });
            } else {
                console.error('ì¹´ì¹´ì˜¤ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                document.getElementById('mapStatus').textContent = 'ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨';
                document.getElementById('searchStatus').textContent = 'ì¹´ì¹´ì˜¤ ì§€ë„ API ë¡œë“œ ì‹¤íŒ¨';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
        window.onload = function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // ì•½ê°„ì˜ ì§€ì—° í›„ ì¹´ì¹´ì˜¤ API ë¡œë“œ ì‹œë„
            setTimeout(() => {
                loadKakaoMap();
            }, 1000);
        };
    </script>
</body>
</html>
