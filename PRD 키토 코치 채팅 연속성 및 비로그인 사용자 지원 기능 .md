# 📋 PRD: 키토 코치 채팅 연속성 및 비로그인 사용자 지원 기능

## 1. 개요

### 1.1 프로젝트 정보

- **프로젝트명**: 키토 코치 (Keto Coach)
- **기능명**: 채팅 연속성 및 게스트 모드 지원
- **작성일**: 2025-01-24
- **예상 개발 기간**: 3-4일
- **우선순위**: High

### 1.2 배경 및 목적

- **현재 문제점**
    - 페이지 새로고침 시 모든 대화 내용이 사라짐
    - 채팅 메시지가 DB에 저장되지 않음
    - 비로그인 사용자가 서비스를 체험할 수 없음
- **목적**
    - 사용자 경험 개선을 위한 대화 연속성 확보
    - 비로그인 사용자도 서비스를 체험할 수 있도록 진입 장벽 낮추기
    - 향후 대화 기록 기반 개인화 서비스의 기초 마련

## 2. 기능 요구사항

### 2.1 비로그인 사용자 지원 (P0 - 필수)

### 기능 설명

비로그인 사용자도 채팅 기능을 사용할 수 있도록 게스트 모드 지원

### 세부 요구사항

| 구분 | 요구사항 | 구현 방법 |
| --- | --- | --- |
| 게스트 ID 생성 | 첫 방문 시 고유 게스트 ID 자동 생성 | UUID v4 사용 |
| 게스트 ID 저장 | 브라우저에 게스트 ID 영구 저장 | localStorage 활용 |
| 게스트 채팅 저장 | 게스트의 대화도 DB에 저장 | chat 테이블의 guest_id 컬럼 활용 |
| 로그인 전환 | 로그인 시 게스트 대화를 계정으로 이전 (선택사항) | 추후 구현 |

### 제한사항

- 게스트 대화는 30일 후 자동 삭제
- 게스트는 식단 저장 기능 사용 불가

### 2.2 채팅 메시지 저장 (P0 - 필수)

### 기능 설명

모든 대화 내용을 데이터베이스에 저장하여 영구 보관

### 세부 요구사항

| 구분 | 요구사항 | 저장 위치 |
| --- | --- | --- |
| 사용자 메시지 | 사용자가 입력한 모든 메시지 저장 | chat 테이블 |
| AI 응답 | AI가 생성한 모든 응답 저장 | chat 테이블 |
| 메타데이터 | 시간, 세션 ID, 의도 분류 결과 저장 | chat 테이블 |
| 스레드 관리 | 대화 묶음 단위로 관리 | chat_thread 테이블 |

### 데이터 구조

```sql
-- chat 테이블 (이미 존재)
- id: 메시지 고유 ID
- user_id: 로그인 사용자 ID (nullable)
- guest_id: 게스트 사용자 ID (nullable)
- thread_id: 대화 스레드 ID
- role: 'user' | 'assistant'
- message: 메시지 내용
- created_at: 생성 시간

```

### 2.3 대화 불러오기 (P0 - 필수)

### 기능 설명

페이지 로드 시 이전 대화 내용을 자동으로 불러와 표시

### 세부 요구사항

| 구분 | 요구사항 | 구현 방법 |
| --- | --- | --- |
| 최근 대화 조회 | 가장 최근 대화 스레드 자동 로드 | 페이지 로드 시 API 호출 |
| 메시지 개수 제한 | 최초 20개 메시지만 로드 | SQL LIMIT 사용 |
| 추가 로드 | 스크롤 시 이전 메시지 추가 로드 (선택사항) | 추후 구현 |
| 로딩 상태 표시 | 메시지 로드 중 스켈레톤 UI 표시 | React 로딩 컴포넌트 |

### 2.4 대화 스레드 관리 (P0 - 필수)

### 기능 설명

여러 개의 독립적인 대화를 관리할 수 있는 기능

### 세부 요구사항

| 구분 | 요구사항 | 구현 방법 |
| --- | --- | --- |
| 새 대화 시작 | "새 대화" 버튼으로 새 스레드 생성 | 새 thread_id 생성 |
| 대화 목록 | 이전 대화 목록 조회 | 사이드바에 표시 |
| 대화 전환 | 대화 간 자유로운 전환 | thread_id로 메시지 필터링 |
| 대화 제목 | 첫 메시지로 자동 제목 생성 | 첫 메시지 30자 요약 |

## 3. 기술 구현 명세

### 3.1 Frontend 구현

### 3.1.1 게스트 ID 관리 (`authStore.ts`)

```tsx
// 구현 위치: frontend/src/store/authStore.ts
- getGuestId(): 게스트 ID 조회/생성
- isGuest: 게스트 여부 확인
- localStorage 키: 'keto_guest_id'

```

### 3.1.2 채팅 페이지 수정 (`ChatPage.tsx`)

```tsx
// 구현 위치: frontend/src/pages/ChatPage.tsx
- useEffect: 페이지 로드 시 이전 대화 불러오기
- sendMessage: 메시지 전송 시 user_id 또는 guest_id 포함
- loadChatHistory: 대화 이력 로드 함수

```

### 3.1.3 API 훅 추가 (`useApi.ts`)

```tsx
// 구현 위치: frontend/src/hooks/useApi.ts
- useGetChatHistory: 대화 이력 조회
- useGetChatThreads: 대화 목록 조회

```

### 3.2 Backend 구현

### 3.2.1 채팅 API 수정 (`chat.py`)

```python
# 구현 위치: backend/app/domains/chat/api/chat.py

# POST /chat - 메시지 저장 로직 추가
- guest_id 파라미터 처리
- Supabase에 메시지 저장
- thread_id 관리

# GET /chat/history/{thread_id} - 새 엔드포인트
- 특정 스레드의 메시지 조회
- 페이징 처리 (limit=20)

# GET /chat/threads - 새 엔드포인트
- 사용자의 모든 스레드 목록 조회

```

### 3.2.2 데이터베이스 작업

```python
# Supabase 클라이언트 사용 (이미 설정됨)
- INSERT: 메시지 저장
- SELECT: 메시지 조회
- UPDATE: 스레드 최종 메시지 시간 업데이트

```

## 4. 구현 우선순위 및 일정


## 5. 테스트 시나리오

### 5.1 기본 기능 테스트

1. **게스트 모드**
    - [ ]  비로그인 상태로 채팅 가능
    - [ ]  게스트 ID가 localStorage에 저장됨
    - [ ]  브라우저 재시작 후에도 게스트 ID 유지
2. **메시지 저장**
    - [ ]  사용자 메시지가 DB에 저장됨
    - [ ]  AI 응답이 DB에 저장됨
    - [ ]  저장된 메시지의 시간 정보 정확함
3. **대화 연속성**
    - [ ]  페이지 새로고침 후 이전 대화 표시
    - [ ]  메시지 순서가 올바름
    - [ ]  20개 이상의 메시지 처리

### 5.2 엣지 케이스

- [ ]  네트워크 오류 시 적절한 에러 메시지
- [ ]  동시에 여러 탭에서 채팅 시 동기화
- [ ]  로그인/로그아웃 전환 시 대화 처리

## 6. 성공 지표

| 지표 | 목표 | 측정 방법 |
| 페이지 로드 시간 | 2초 이내 | Performance API |


## 7. 향후 개선 사항

- **Phase 3 (추후)**
    - 대화 검색 기능

## 9. 참고 사항

- 기존 코드의 TODO 주석 부분을 우선 완성
- 복잡한 기능보다 안정성 우선
- 팀원 수준에 맞춰 단순한 구현 선택
- 문서화와 주석을 충분히 작성

---
# task
- 첨부파일을 참조해서 기능 구현을 하고 싶어
- 요구사항대로 개발해줘
# 요구사항
- 첨부파일 내용대로 개발해줘
- 우선순위와 todo 리스트를 작성해서 개발해줘
- 프론트엔드 부분을 수정할 땐 주석으로 어떤 부분을 고쳤는지 알려줘
# 첨부파일
